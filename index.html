<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDIPP Volunteer Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --sdipp-primary: #dc2626;
            --sdipp-secondary: #1e40af;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .sdipp-gradient {
            background: linear-gradient(135deg, var(--sdipp-primary) 0%, #b91c1c 100%);
        }
        .sdipp-card {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: all 0.2s ease;
        }
        .sdipp-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        .sdipp-btn {
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .sdipp-btn-primary {
            background: var(--sdipp-primary);
            color: white;
        }
        .sdipp-btn-primary:hover {
            background: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }
        .logo-container {
            max-width: 200px;
            height: auto;
        }
        input[type="checkbox"]:checked,
        input[type="radio"]:checked {
            background-color: #dc2626;
            border-color: #dc2626;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .probation-banner {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .training-required {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDoc, 
            getDocs, 
            updateDoc,
            deleteDoc,
            arrayUnion,
            arrayRemove,
            query,
            where,
            orderBy,
            serverTimestamp,
            increment,
            Timestamp,
            writeBatch
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ===================================
        // FIREBASE CONFIGURATION
        // ===================================
        const firebaseConfig = {
            apiKey: "AIzaSyAUBj3-QxahYuhxjdkOfIAJzGtXiLp3_RA",
            authDomain: "sdipp-volunteer-portal.firebaseapp.com",
            projectId: "sdipp-volunteer-portal",
            storageBucket: "sdipp-volunteer-portal.firebasestorage.app",
            messagingSenderId: "1060878474479",
            appId: "1:1060878474479:web:9202a51329d172e4568f1a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ===================================
        // STATE MANAGEMENT
        // ===================================
        let currentUser = null;
        let currentUserData = null;
        let allEvents = [];
        let allVolunteers = [];
        let allRewards = [];
        let allTags = [];
        let currentView = 'main';
        let selectedVolunteerId = null;

        // ===================================
        // AUTHENTICATION
        // ===================================
        async function signUp(email, password, userData) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await updateProfile(user, {
                    displayName: `${userData.firstName} ${userData.lastName}`
                });

                await setDoc(doc(db, 'users', user.uid), {
                    firstName: userData.firstName,
                    lastName: userData.lastName,
                    email: email,
                    role: 'volunteer',
                    interests: userData.interests || [],
                    population: userData.population || [],
                    emailNotifications: userData.emailNotifications || false,
                    hours: 0,
                    points: 10,
                    rank: 'Novice',
                    registeredEvents: [],
                    completedEvents: [],
                    isTrainingCompleted: false, // NEW: Training requirement
                    absences: 0, // NEW: Track absences
                    isProbation: false, // NEW: Probation status
                    probationUntil: null, // NEW: When probation ends
                    probationReason: '', // NEW: Why on probation
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });

                if (userData.emailNotifications) {
                    await createEmailNotification({
                        to: email,
                        type: 'welcome',
                        subject: 'Welcome to SDIPP! üè•',
                        userData: { firstName: userData.firstName, lastName: userData.lastName }
                    });
                }

                return { success: true, user };
            } catch (error) {
                console.error('Signup error:', error);
                return { success: false, error: error.message };
            }
        }

        async function signIn(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                return { success: true, user: userCredential.user };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function logOut() {
            try {
                await signOut(auth);
                currentUser = null;
                currentUserData = null;
                window.location.reload();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // ===================================
        // EMAIL NOTIFICATIONS
        // ===================================
        async function createEmailNotification(emailData) {
            try {
                await setDoc(doc(collection(db, 'mail')), {
                    to: emailData.to,
                    message: {
                        subject: emailData.subject,
                        html: generateEmailHTML(emailData)
                    },
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.error('Email notification error:', error);
            }
        }

        function generateEmailHTML(emailData) {
            const baseURL = window.location.origin + window.location.pathname;
            
            switch(emailData.type) {
                case 'welcome':
                    return `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <h1 style="color: #dc2626;">Welcome to SDIPP! üè•</h1>
                        <p>Hi ${emailData.userData.firstName},</p>
                        <p>Thank you for joining SDIPP! You've started with <strong>10 welcome points</strong>.</p>
                        <p><strong>Important:</strong> Please attend a General Training event to unlock full event registration.</p>
                        <p><a href="${baseURL}" style="background: #dc2626; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block; margin-top: 16px;">View Events</a></p>
                        <p style="color: #666; font-size: 14px; margin-top: 24px;">Best regards,<br>SDIPP Team</p>
                    </div>`;
                
                case 'new_event':
                    const eventDate = emailData.eventData.date.toDate();
                    return `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <h1 style="color: #dc2626;">New Event You Might Like! üìÖ</h1>
                        <p>Hi ${emailData.userData.firstName},</p>
                        <p>SDIPP has posted an event matching your interests:</p>
                        <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin: 20px 0;">
                            <h2 style="margin-top: 0; color: #1f2937;">${emailData.eventData.title}</h2>
                            <p><strong>üìÖ Date:</strong> ${eventDate.toLocaleDateString()}</p>
                            <p><strong>üïê Time:</strong> ${emailData.eventData.startTime} - ${emailData.eventData.endTime}</p>
                            <p><strong>üìç Location:</strong> ${emailData.eventData.location}</p>
                            <p>${emailData.eventData.description}</p>
                        </div>
                        <p><a href="${baseURL}" style="background: #dc2626; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; display: inline-block;">Register Now</a></p>
                    </div>`;
                
                case 'probation':
                    return `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <h1 style="color: #f59e0b;">Probation Notice ‚ö†Ô∏è</h1>
                        <p>Hi ${emailData.userData.firstName},</p>
                        <p>You have been placed on probation for 3 months due to ${emailData.absences} missed events.</p>
                        <p><strong>Probation Period:</strong> Until ${emailData.probationUntil}</p>
                        <p>During this time, you cannot register for new events. Your account will be automatically restored after the probation period.</p>
                        <p style="color: #666; font-size: 14px; margin-top: 24px;">If you have questions, please contact the SDIPP team.</p>
                    </div>`;
                
                default:
                    return '<p>SDIPP Notification</p>';
            }
        }

        // ===================================
        // FIRESTORE FUNCTIONS
        // ===================================
        async function getCurrentUserData(userId) {
            const userDoc = await getDoc(doc(db, 'users', userId));
            if (userDoc.exists()) {
                const data = { id: userDoc.id, ...userDoc.data() };
                
                // Check if probation has expired
                if (data.isProbation && data.probationUntil) {
                    const probationEnd = data.probationUntil.toDate();
                    if (new Date() > probationEnd) {
                        // Probation expired, restore account
                        await updateDoc(doc(db, 'users', userId), {
                            isProbation: false,
                            probationUntil: null,
                            probationReason: '',
                            absences: 0,
                            updatedAt: serverTimestamp()
                        });
                        data.isProbation = false;
                        data.probationUntil = null;
                        data.absences = 0;
                    }
                }
                
                return data;
            }
            return null;
        }

        async function getAllEvents() {
            const eventsSnapshot = await getDocs(
                query(collection(db, 'events'), orderBy('date', 'asc'))
            );
            return eventsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function getAllVolunteers() {
            const volunteersSnapshot = await getDocs(collection(db, 'users'));
            return volunteersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function getAllRewards() {
            const rewardsSnapshot = await getDocs(
                query(collection(db, 'rewards'), where('available', '==', true))
            );
            return rewardsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function getAllTags() {
            const tagsSnapshot = await getDocs(collection(db, 'tags'));
            const tags = tagsSnapshot.docs.map(doc => doc.data().name);
            return [...new Set(tags)].sort();
        }

        async function addNewTag(tagName) {
            try {
                await setDoc(doc(collection(db, 'tags')), {
                    name: tagName,
                    createdAt: serverTimestamp()
                });
                allTags = await getAllTags();
                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function registerForEvent(eventId, userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                const userData = userDoc.data();

                // Check probation
                if (userData.isProbation) {
                    throw new Error('You are currently on probation and cannot register for events.');
                }

                const eventRef = doc(db, 'events', eventId);
                const eventDoc = await getDoc(eventRef);
                
                if (!eventDoc.exists()) throw new Error('Event not found');
                const event = eventDoc.data();

                // Check if it's a general training event
                const isGeneralTraining = event.tags?.some(tag => 
                    tag.toLowerCase().includes('general training')
                );

                // If not general training and user hasn't completed training, block registration
                if (!isGeneralTraining && !userData.isTrainingCompleted) {
                    throw new Error('Please complete General Training before registering for other events.');
                }
                
                if (event.registeredCount >= event.maxCapacity) {
                    throw new Error('Event is full');
                }
                if (event.registeredVolunteers?.includes(userId)) {
                    throw new Error('Already registered');
                }

                const pointsForRegistration = 5;

                await updateDoc(eventRef, {
                    registeredVolunteers: arrayUnion(userId),
                    registeredCount: increment(1),
                    updatedAt: serverTimestamp()
                });

                await updateDoc(doc(db, 'users', userId), {
                    registeredEvents: arrayUnion(eventId),
                    points: increment(pointsForRegistration),
                    updatedAt: serverTimestamp()
                });

                await setDoc(doc(db, 'attendance', `${eventId}_${userId}`), {
                    eventId: eventId,
                    userId: userId,
                    eventTitle: event.title,
                    eventDate: event.date,
                    hoursEarned: 0,
                    pointsEarned: pointsForRegistration,
                    status: 'registered',
                    registeredAt: serverTimestamp(),
                    reminderSent: false
                });

                if (userData.emailNotifications) {
                    await createEmailNotification({
                        to: userData.email,
                        type: 'registration',
                        subject: `Registered: ${event.title}`,
                        userData: { firstName: userData.firstName },
                        eventData: event
                    });
                }

                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function unregisterFromEvent(eventId, userId) {
            try {
                await updateDoc(doc(db, 'events', eventId), {
                    registeredVolunteers: arrayRemove(userId),
                    registeredCount: increment(-1),
                    updatedAt: serverTimestamp()
                });

                await updateDoc(doc(db, 'users', userId), {
                    registeredEvents: arrayRemove(eventId),
                    updatedAt: serverTimestamp()
                });

                await deleteDoc(doc(db, 'attendance', `${eventId}_${userId}`));
                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function createEvent(eventData) {
            try {
                const eventRef = doc(collection(db, 'events'));
                const eventDoc = {
                    ...eventData,
                    date: Timestamp.fromDate(new Date(eventData.date)),
                    registeredCount: 0,
                    registeredVolunteers: [],
                    createdBy: currentUser.uid,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };
                
                await setDoc(eventRef, eventDoc);
                await notifyInterestedVolunteers(eventDoc, eventRef.id);

                return { success: true, id: eventRef.id };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function notifyInterestedVolunteers(event, eventId) {
            const eventTags = event.tags || [];
            if (eventTags.length === 0) return;

            const volunteersQuery = query(
                collection(db, 'users'),
                where('emailNotifications', '==', true),
                where('role', '==', 'volunteer')
            );
            
            const volunteersSnapshot = await getDocs(volunteersQuery);
            
            for (const volunteerDoc of volunteersSnapshot.docs) {
                const volunteer = volunteerDoc.data();
                const volunteerInterests = volunteer.interests || [];
                
                const matchedTags = eventTags.filter(tag => 
                    volunteerInterests.some(interest => 
                        interest.toLowerCase() === tag.toLowerCase()
                    )
                );
                
                if (matchedTags.length > 0) {
                    await createEmailNotification({
                        to: volunteer.email,
                        type: 'new_event',
                        subject: `New Event: ${event.title}`,
                        userData: { firstName: volunteer.firstName },
                        eventData: event,
                        matchedTags: matchedTags
                    });
                }
            }
        }

        async function updateEvent(eventId, eventData) {
            try {
                const updateData = { ...eventData, updatedAt: serverTimestamp() };
                if (eventData.date) {
                    updateData.date = Timestamp.fromDate(new Date(eventData.date));
                }
                await updateDoc(doc(db, 'events', eventId), updateData);
                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function deleteEvent(eventId) {
            try {
                await deleteDoc(doc(db, 'events', eventId));
                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function markAllAttended(eventId) {
            try {
                const eventDoc = await getDoc(doc(db, 'events', eventId));
                const event = eventDoc.data();
                const volunteers = event.registeredVolunteers || [];
                
                const batch = writeBatch(db);
                
                // Check if this is a general training event
                const isGeneralTraining = event.tags?.some(tag => 
                    tag.toLowerCase().includes('general training')
                );

                for (const userId of volunteers) {
                    const attendanceRef = doc(db, 'attendance', `${eventId}_${userId}`);
                    batch.update(attendanceRef, {
                        status: 'attended',
                        hoursEarned: event.hoursAwarded || 0,
                        pointsEarned: event.pointsAwarded || 0,
                        markedBy: currentUser.uid,
                        markedAt: serverTimestamp()
                    });

                    const userRef = doc(db, 'users', userId);
                    const updateData = {
                        hours: increment(event.hoursAwarded || 0),
                        points: increment(event.pointsAwarded || 0),
                        completedEvents: arrayUnion(eventId),
                        updatedAt: serverTimestamp()
                    };

                    // Mark training as completed if this is general training
                    if (isGeneralTraining) {
                        updateData.isTrainingCompleted = true;
                    }

                    batch.update(userRef, updateData);
                }
                
                await batch.commit();
                
                for (const userId of volunteers) {
                    await checkMilestones(userId);
                }
                
                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function markAttendance(eventId, userId, status) {
            try {
                const attendanceRef = doc(db, 'attendance', `${eventId}_${userId}`);
                const eventDoc = await getDoc(doc(db, 'events', eventId));
                const event = eventDoc.data();
                const userDoc = await getDoc(doc(db, 'users', userId));
                const userData = userDoc.data();

                const isGeneralTraining = event.tags?.some(tag => 
                    tag.toLowerCase().includes('general training')
                );

                if (status === 'attended') {
                    await updateDoc(attendanceRef, {
                        status: 'attended',
                        hoursEarned: event.hoursAwarded || 0,
                        pointsEarned: event.pointsAwarded || 0,
                        markedBy: currentUser.uid,
                        markedAt: serverTimestamp()
                    });

                    const updateData = {
                        hours: increment(event.hoursAwarded || 0),
                        points: increment(event.pointsAwarded || 0),
                        completedEvents: arrayUnion(eventId),
                        updatedAt: serverTimestamp()
                    };

                    if (isGeneralTraining) {
                        updateData.isTrainingCompleted = true;
                    }

                    await updateDoc(doc(db, 'users', userId), updateData);
                    await checkMilestones(userId);

                } else if (status === 'absent') {
                    await updateDoc(attendanceRef, {
                        status: 'absent',
                        markedBy: currentUser.uid,
                        markedAt: serverTimestamp()
                    });

                    // Increment absence count
                    const newAbsences = (userData.absences || 0) + 1;
                    const updateData = {
                        absences: newAbsences,
                        updatedAt: serverTimestamp()
                    };

                    // If 3 absences, place on probation for 3 months
                    if (newAbsences >= 3) {
                        const probationEnd = new Date();
                        probationEnd.setMonth(probationEnd.getMonth() + 3);
                        
                        updateData.isProbation = true;
                        updateData.probationUntil = Timestamp.fromDate(probationEnd);
                        updateData.probationReason = `${newAbsences} missed events`;

                        // Send probation email
                        if (userData.emailNotifications) {
                            await createEmailNotification({
                                to: userData.email,
                                type: 'probation',
                                subject: 'SDIPP Probation Notice',
                                userData: { firstName: userData.firstName },
                                absences: newAbsences,
                                probationUntil: probationEnd.toLocaleDateString()
                            });
                        }
                    }

                    await updateDoc(doc(db, 'users', userId), updateData);
                }

                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function checkMilestones(userId) {
            const userDoc = await getDoc(doc(db, 'users', userId));
            const userData = userDoc.data();
            const hours = userData.hours || 0;

            const milestones = [
                { hours: 10, type: 'hours_10', title: 'First 10 Hours', points: 50 },
                { hours: 30, type: 'hours_30', title: 'Promoted to Senior', points: 100, rank: 'Senior' },
                { hours: 50, type: 'hours_50', title: '50 Hour Champion', points: 150 },
                { hours: 100, type: 'hours_100', title: '100 Hour Hero', points: 300 }
            ];

            for (const milestone of milestones) {
                if (hours >= milestone.hours) {
                    const milestoneQuery = query(
                        collection(db, 'milestones'),
                        where('userId', '==', userId),
                        where('type', '==', milestone.type)
                    );
                    const existingMilestone = await getDocs(milestoneQuery);

                    if (existingMilestone.empty) {
                        await setDoc(doc(collection(db, 'milestones')), {
                            userId: userId,
                            type: milestone.type,
                            title: milestone.title,
                            pointsAwarded: milestone.points,
                            achievedAt: serverTimestamp()
                        });

                        const updateData = {
                            points: increment(milestone.points),
                            updatedAt: serverTimestamp()
                        };

                        if (milestone.rank) {
                            updateData.rank = milestone.rank;
                        }

                        await updateDoc(doc(db, 'users', userId), updateData);
                    }
                }
            }
        }

        async function redeemReward(rewardId, userId) {
            try {
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);
                const userData = userDoc.data();

                const rewardDoc = await getDoc(doc(db, 'rewards', rewardId));
                const reward = rewardDoc.data();

                if (userData.points < reward.pointsCost) {
                    throw new Error('Not enough points');
                }

                await setDoc(doc(collection(db, 'redemptions')), {
                    userId: userId,
                    rewardId: rewardId,
                    rewardName: reward.name,
                    pointsSpent: reward.pointsCost,
                    redeemedAt: serverTimestamp(),
                    status: 'pending'
                });

                await updateDoc(userRef, {
                    points: increment(-reward.pointsCost),
                    updatedAt: serverTimestamp()
                });

                return { success: true };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function getEventAttendance(eventId) {
            const attendanceQuery = query(
                collection(db, 'attendance'),
                where('eventId', '==', eventId)
            );
            const attendanceSnapshot = await getDocs(attendanceQuery);
            return attendanceSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function getVolunteerAttendance(userId) {
            const attendanceQuery = query(
                collection(db, 'attendance'),
                where('userId', '==', userId),
                where('status', '==', 'attended')
            );
            const attendanceSnapshot = await getDocs(attendanceQuery);
            return attendanceSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        // ===================================
        // UI RENDERING
        // ===================================
        
        function render() {
            const app = document.getElementById('app');
            
            if (!currentUser) {
                app.innerHTML = renderAuthPage();
            } else if (currentUserData?.role === 'admin') {
                if (currentView === 'volunteer-detail') {
                    app.innerHTML = renderVolunteerDetailPage();
                } else {
                    app.innerHTML = renderAdminDashboard();
                }
            } else {
                app.innerHTML = renderVolunteerDashboard();
            }

            attachEventListeners();
        }

        function renderAuthPage() {
            return `
                <div class="min-h-screen sdipp-gradient flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div class="text-center mb-8">
                            <img src="./sdipp-logo.webp" alt="SDIPP Logo" class="logo-container mx-auto mb-4" />
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">SDIPP Volunteer Portal</h1>
                            <p class="text-gray-600">San Diego Injury Prevention Program</p>
                        </div>

                        <div id="auth-container">
                            <div id="login-form">
                                <h2 class="text-2xl font-bold mb-4">Sign In</h2>
                                <div id="login-error" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
                                <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-3 border rounded-xl mb-3 focus:ring-2 focus:ring-red-500" />
                                <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-3 border rounded-xl mb-4 focus:ring-2 focus:ring-red-500" />
                                <button onclick="handleLogin()" class="sdipp-btn sdipp-btn-primary w-full mb-3">Sign In</button>
                                <button onclick="showSignup()" class="w-full text-red-600 hover:underline font-medium">Create New Account</button>
                            </div>

                            <div id="signup-form" class="hidden">
                                <h2 class="text-2xl font-bold mb-4">Join SDIPP</h2>
                                <div id="signup-error" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
                                
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <input type="text" id="signup-firstname" placeholder="First Name *" class="px-4 py-3 border rounded-xl focus:ring-2 focus:ring-red-500" required />
                                    <input type="text" id="signup-lastname" placeholder="Last Name *" class="px-4 py-3 border rounded-xl focus:ring-2 focus:ring-red-500" required />
                                </div>
                                <input type="email" id="signup-email" placeholder="Email (@ucsd.edu) *" class="w-full px-4 py-3 border rounded-xl mb-3 focus:ring-2 focus:ring-red-500" required />
                                <input type="password" id="signup-password" placeholder="Password (min 6 chars) *" class="w-full px-4 py-3 border rounded-xl mb-4 focus:ring-2 focus:ring-red-500" required />
                                
                                <div class="mb-3">
                                    <label class="font-semibold text-sm mb-2 block">Areas of Interest: *</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        ${['Pediatric', 'Geriatric', 'Sports Injury Prevention', 'Health Education', 'Community Health', 'Occupational Safety'].map(interest => `
                                            <label class="flex items-center gap-2 text-sm cursor-pointer">
                                                <input type="checkbox" name="interests" value="${interest}" class="rounded text-red-600 focus:ring-red-500" />
                                                ${interest}
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="font-semibold text-sm mb-2 block">Population to serve: *</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        ${['Children', 'Seniors', 'Veterans', 'Students', 'Low-Income Families'].map(pop => `
                                            <label class="flex items-center gap-2 text-sm cursor-pointer">
                                                <input type="checkbox" name="population" value="${pop}" class="rounded text-red-600 focus:ring-red-500" />
                                                ${pop}
                                            </label>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="mb-4 p-4 bg-blue-50 rounded-xl border border-blue-200">
                                    <label class="flex items-start gap-3 cursor-pointer">
                                        <input type="checkbox" id="email-consent" class="mt-1 rounded text-red-600 focus:ring-red-500" />
                                        <div class="text-sm">
                                            <p class="font-semibold text-gray-900 mb-1">üìß Email Notifications</p>
                                            <p class="text-gray-700">Receive emails about new events matching your interests and 24-hour reminders.</p>
                                        </div>
                                    </label>
                                </div>

                                <button onclick="handleSignup()" class="sdipp-btn sdipp-btn-primary w-full mb-3">Create Account</button>
                                <button onclick="showLogin()" class="w-full text-red-600 hover:underline font-medium">Back to Sign In</button>
                                <p class="text-xs text-gray-500 text-center mt-4">* Required fields</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderVolunteerDashboard() {
            const registeredEvents = allEvents.filter(e => 
                currentUserData.registeredEvents?.includes(e.id)
            );
            const completedEvents = allEvents.filter(e => 
                currentUserData.completedEvents?.includes(e.id)
            );
            const upcomingEvents = allEvents.filter(e => {
                const eventDate = e.date?.toDate ? e.date.toDate() : new Date(e.date);
                return eventDate > new Date() && !currentUserData.registeredEvents?.includes(e.id);
            });

            let statusBanner = '';
            
            if (currentUserData.isProbation) {
                const endDate = currentUserData.probationUntil?.toDate().toLocaleDateString();
                statusBanner = `
                    <div class="probation-banner">
                        <h3 class="font-bold text-lg mb-2">‚ö†Ô∏è Account on Probation</h3>
                        <p>You cannot register for events until <strong>${endDate}</strong> due to ${currentUserData.absences} missed events.</p>
                        <p class="text-sm mt-2">Your account will be automatically restored after this date.</p>
                    </div>
                `;
            } else if (!currentUserData.isTrainingCompleted) {
                statusBanner = `
                    <div class="training-required">
                        <h3 class="font-bold text-lg mb-2">üìö Training Required</h3>
                        <p>Please complete a <strong>General Training</strong> event before registering for other events.</p>
                        <p class="text-sm mt-2">Look for events tagged "General Training" below.</p>
                    </div>
                `;
            }

            return `
                <div class="min-h-screen bg-gray-50">
                    <header class="bg-white shadow-sm border-b">
                        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <img src="./sdipp-logo.webp" alt="SDIPP" class="h-12" />
                                <div>
                                    <h1 class="text-xl font-bold text-gray-900">Welcome, ${currentUserData.firstName}!</h1>
                                    <p class="text-sm text-gray-600">San Diego Injury Prevention Program</p>
                                </div>
                            </div>
                            <button onclick="handleLogout()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg font-medium transition">
                                Logout
                            </button>
                        </div>
                    </header>

                    <div class="max-w-7xl mx-auto px-6 py-8">
                        ${statusBanner}

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                            <div class="sdipp-card p-6">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-sm font-medium text-gray-600">Total Hours</p>
                                    <span class="text-2xl">‚è±Ô∏è</span>
                                </div>
                                <p class="text-3xl font-bold text-gray-900">${currentUserData.hours || 0}</p>
                            </div>
                            
                            <div class="sdipp-card p-6">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-sm font-medium text-gray-600">Rank</p>
                                    <span class="text-2xl">${currentUserData.rank === 'Senior' ? 'üåü' : 'üéØ'}</span>
                                </div>
                                <p class="text-3xl font-bold text-gray-900">${currentUserData.rank || 'Novice'}</p>
                            </div>
                            
                            <div class="sdipp-card p-6">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-sm font-medium text-gray-600">Points</p>
                                    <span class="text-2xl">üéØ</span>
                                </div>
                                <p class="text-3xl font-bold text-gray-900">${currentUserData.points || 0}</p>
                            </div>
                            
                            <div class="sdipp-card p-6">
                                <div class="flex items-center justify-between mb-2">
                                    <p class="text-sm font-medium text-gray-600">Events</p>
                                    <span class="text-2xl">üìÖ</span>
                                </div>
                                <p class="text-3xl font-bold text-gray-900">${registeredEvents.length}</p>
                                <p class="text-xs text-gray-500 mt-1">Registered</p>
                            </div>
                        </div>

                        ${registeredEvents.length > 0 ? `
                            <div class="mb-8">
                                <h2 class="text-2xl font-bold mb-4 text-gray-900">Your Upcoming Events</h2>
                                <div class="space-y-4">
                                    ${registeredEvents.map(event => renderEventCard(event, true)).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="mb-8">
                            <h2 class="text-2xl font-bold mb-4 text-gray-900">Available Events</h2>
                            ${upcomingEvents.length > 0 ? `
                                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    ${upcomingEvents.map(event => renderEventCard(event, false)).join('')}
                                </div>
                            ` : `
                                <div class="sdipp-card p-8 text-center text-gray-500">
                                    No upcoming events at this time.
                                </div>
                            `}
                        </div>

                        <div class="grid md:grid-cols-2 gap-6 mb-8">
                            <div class="sdipp-card p-6">
                                <h3 class="text-xl font-bold mb-4 text-gray-900">Completed Events</h3>
                                ${completedEvents.length > 0 ? `
                                    <div class="space-y-3">
                                        ${completedEvents.slice(0, 5).map(event => `
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div>
                                                    <p class="font-semibold text-sm">${event.title}</p>
                                                    <p class="text-xs text-gray-600">${formatDate(event.date)}</p>
                                                </div>
                                                <span class="font-bold text-blue-600 text-sm">${event.hoursAwarded || 0} hrs</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <p class="text-gray-500 text-center py-8">No completed events yet</p>
                                `}
                            </div>

                            <div class="sdipp-card p-6 bg-gradient-to-br from-blue-50 to-indigo-50">
                                <h3 class="text-xl font-bold mb-3 text-gray-900">Request Official Hours</h3>
                                <p class="text-gray-700 mb-4 text-sm">
                                    Need official documentation of your volunteer hours?
                                </p>
                                <a 
                                    href="https://docs.google.com/forms/d/e/1FAIpQLSciXetsMs3y6Xdf7iVHA4pFH1WtGFaU0V_LNqibdWjZL2YBJw/viewform" 
                                    target="_blank"
                                    class="sdipp-btn sdipp-btn-primary inline-block text-center w-full">
                                    Request Document ‚Üí
                                </a>
                            </div>
                        </div>

                        ${allRewards.length > 0 ? `
                            <div>
                                <h2 class="text-2xl font-bold mb-4 text-gray-900">Redeem Your Points</h2>
                                <div class="grid md:grid-cols-3 gap-4">
                                    ${allRewards.map(reward => `
                                        <div class="sdipp-card p-6 text-center">
                                            <div class="text-5xl mb-3">${reward.icon}</div>
                                            <h3 class="font-bold text-lg mb-2">${reward.name}</h3>
                                            <p class="text-sm text-gray-600 mb-3">${reward.description}</p>
                                            <p class="text-2xl font-bold text-red-600 mb-4">${reward.pointsCost} pts</p>
                                            <button 
                                                onclick="handleRedeemReward('${reward.id}')"
                                                ${(currentUserData.points || 0) < reward.pointsCost ? 'disabled' : ''}
                                                class="sdipp-btn w-full ${(currentUserData.points || 0) >= reward.pointsCost ? 'sdipp-btn-primary' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}">
                                                ${(currentUserData.points || 0) >= reward.pointsCost ? 'Redeem' : 'Locked'}
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderEventCard(event, isRegistered) {
            const eventDate = event.date?.toDate ? event.date.toDate() : new Date(event.date);
            const isFull = event.registeredCount >= event.maxCapacity;
            const isGeneralTraining = event.tags?.some(tag => tag.toLowerCase().includes('general training'));
            const canRegister = !currentUserData.isProbation && (currentUserData.isTrainingCompleted || isGeneralTraining);

            return `
                <div class="sdipp-card p-5">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-lg flex-1 text-gray-900">${event.title}</h3>
                        <span class="${isFull ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'} px-3 py-1 rounded-full text-xs font-semibold">
                            ${event.registeredCount}/${event.maxCapacity}
                        </span>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mb-3">
                        ${(event.tags || []).slice(0, 3).map(tag => `
                            <span class="px-2 py-1 ${tag.toLowerCase().includes('general training') ? 'bg-purple-100 text-purple-700' : 'bg-red-50 text-red-700'} rounded-lg text-xs font-medium">${tag}</span>
                        `).join('')}
                    </div>

                    <p class="text-sm text-gray-700 mb-4 line-clamp-2">${event.description}</p>

                    <div class="space-y-2 text-sm text-gray-600 mb-4">
                        <p>üìÖ ${eventDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</p>
                        <p>üïê ${event.startTime} - ${event.endTime}</p>
                        <p>‚è±Ô∏è ${event.hoursAwarded || 0} hours ‚Ä¢ ${event.pointsAwarded || 0} points</p>
                    </div>

                    ${isRegistered ? `
                        <button onclick="handleUnregister('${event.id}')" class="w-full py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 font-semibold transition">
                            Cancel Registration
                        </button>
                    ` : `
                        <button 
                            onclick="handleRegister('${event.id}')"
                            ${!canRegister || isFull ? 'disabled' : ''}
                            class="sdipp-btn w-full ${!canRegister || isFull ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'sdipp-btn-primary'}">
                            ${isFull ? 'Event Full' : !canRegister ? (currentUserData.isProbation ? 'On Probation' : 'Training Required') : 'Register (+5 pts)'}
                        </button>
                    `}
                </div>
            `;
        }

        function renderAdminDashboard() {
            return `
                <div class="min-h-screen bg-gray-50">
                    <header class="bg-white shadow-sm border-b">
                        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <img src="./sdipp-logo.webp" alt="SDIPP" class="h-12" />
                                <div>
                                    <h1 class="text-xl font-bold text-gray-900">SDIPP Admin Dashboard</h1>
                                    <p class="text-sm text-gray-600">Manage events and volunteers</p>
                                </div>
                            </div>
                            <button onclick="handleLogout()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg font-medium transition">
                                Logout
                            </button>
                        </div>
                    </header>

                    <div class="max-w-7xl mx-auto px-6 py-8">
                        <div class="flex gap-2 mb-6 border-b">
                            <button onclick="setAdminTab('events')" id="tab-events" class="px-6 py-3 font-semibold">Events</button>
                            <button onclick="setAdminTab('attendance')" id="tab-attendance" class="px-6 py-3 font-semibold">Mark Attendance</button>
                            <button onclick="setAdminTab('volunteers')" id="tab-volunteers" class="px-6 py-3 font-semibold">Volunteer Database</button>
                        </div>

                        <div id="admin-content"></div>
                    </div>
                </div>

                <!-- Modals -->
                <div id="create-event-modal" class="modal">
                    <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6 m-4">
                        <div class="flex justify-between mb-4">
                            <h2 class="text-2xl font-bold">Create Event</h2>
                            <button onclick="closeModal('create-event-modal')" class="text-gray-400 hover:text-gray-600">‚úï</button>
                        </div>
                        <div id="event-form-container"></div>
                    </div>
                </div>

                <div id="edit-event-modal" class="modal">
                    <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-6 m-4">
                        <div class="flex justify-between mb-4">
                            <h2 class="text-2xl font-bold">Edit Event</h2>
                            <button onclick="closeModal('edit-event-modal')" class="text-gray-400 hover:text-gray-600">‚úï</button>
                        </div>
                        <div id="edit-event-form-container"></div>
                    </div>
                </div>
            `;
        }

        function renderAdminEventsTab() {
            return `
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Event Management</h2>
                        <button onclick="showCreateEventModal()" class="sdipp-btn sdipp-btn-primary">+ Create Event</button>
                    </div>

                    <div class="sdipp-card overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-6 py-3 text-left text-sm font-semibold">Event</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold">Date</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold">Registered</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold">Hours/Points</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${allEvents.map(event => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4">
                                            <p class="font-semibold">${event.title}</p>
                                            <div class="flex gap-1 mt-1">
                                                ${(event.tags || []).slice(0, 2).map(tag => `
                                                    <span class="px-2 py-0.5 bg-red-50 text-red-700 text-xs rounded">${tag}</span>
                                                `).join('')}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-sm">${formatDate(event.date)}</td>
                                        <td class="px-6 py-4 font-semibold">${event.registeredCount}/${event.maxCapacity}</td>
                                        <td class="px-6 py-4 text-sm">${event.hoursAwarded || 0}h / ${event.pointsAwarded || 0}p</td>
                                        <td class="px-6 py-4">
                                            <button onclick="showEditEventModal('${event.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                                            <button onclick="handleDeleteEvent('${event.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderAdminAttendanceTab() {
            return `
                <div>
                    <h2 class="text-2xl font-bold mb-6">Mark Attendance</h2>
                    <div class="space-y-4">
                        ${allEvents.map(event => {
                            const eventDate = event.date?.toDate ? event.date.toDate() : new Date(event.date);
                            return `
                                <div class="sdipp-card p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 class="text-xl font-bold">${event.title}</h3>
                                            <p class="text-sm text-gray-600">${eventDate.toLocaleDateString()} ‚Ä¢ ${event.startTime} - ${event.endTime}</p>
                                            <p class="text-sm text-gray-600">${event.registeredCount} registered</p>
                                        </div>
                                        ${event.registeredCount > 0 ? `
                                            <button onclick="handleMarkAllAttended('${event.id}')" class="sdipp-btn sdipp-btn-primary">‚úì Mark All Present</button>
                                        ` : ''}
                                    </div>
                                    ${event.registeredCount > 0 ? `
                                        <div id="attendance-${event.id}">
                                            <p class="text-sm text-gray-500">Loading...</p>
                                        </div>
                                    ` : `
                                        <p class="text-gray-500 text-center py-4">No volunteers registered</p>
                                    `}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderAdminVolunteersTab() {
            const volunteers = allVolunteers.filter(v => v.role === 'volunteer').sort((a, b) => (b.hours || 0) - (a.hours || 0));
            
            return `
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Volunteer Database</h2>
                        <input 
                            type="text" 
                            id="volunteer-search" 
                            placeholder="Search by name..." 
                            class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-red-500"
                            onkeyup="filterVolunteers()" 
                        />
                    </div>

                    <div class="sdipp-card overflow-hidden">
                        <table class="w-full" id="volunteers-table">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-6 py-3 text-left text-sm font-semibold cursor-pointer" onclick="sortVolunteers('name')">Name</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold">Email</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold cursor-pointer" onclick="sortVolunteers('hours')">Hours ‚Üì</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold">Status</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${volunteers.map(v => `
                                    <tr class="hover:bg-gray-50 volunteer-row" data-name="${v.firstName} ${v.lastName}">
                                        <td class="px-6 py-4 font-semibold">${v.firstName} ${v.lastName}</td>
                                        <td class="px-6 py-4 text-sm">${v.email}</td>
                                        <td class="px-6 py-4 font-semibold text-blue-600">${v.hours || 0}</td>
                                        <td class="px-6 py-4">
                                            ${v.isProbation ? `
                                                <span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded font-semibold">Probation</span>
                                            ` : !v.isTrainingCompleted ? `
                                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded font-semibold">Training Required</span>
                                            ` : `
                                                <span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded font-semibold">Active</span>
                                            `}
                                        </td>
                                        <td class="px-6 py-4">
                                            <button onclick="showVolunteerDetail('${v.id}')" class="text-blue-600 hover:text-blue-800 font-medium">View Details</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderVolunteerDetailPage() {
            const volunteer = allVolunteers.find(v => v.id === selectedVolunteerId);
            if (!volunteer) {
                currentView = 'main';
                render();
                return '';
            }

            return `
                <div class="min-h-screen bg-gray-50">
                    <header class="bg-white shadow-sm border-b">
                        <div class="max-w-7xl mx-auto px-6 py-4">
                            <button onclick="backToAdmin()" class="text-blue-600 hover:text-blue-800 mb-2">‚Üê Back to Volunteer Database</button>
                            <h1 class="text-2xl font-bold">${volunteer.firstName} ${volunteer.lastName}</h1>
                            <p class="text-gray-600">${volunteer.email}</p>
                        </div>
                    </header>

                    <div class="max-w-7xl mx-auto px-6 py-8">
                        <div class="grid md:grid-cols-4 gap-4 mb-8">
                            <div class="sdipp-card p-6">
                                <p class="text-sm text-gray-600 mb-1">Total Hours</p>
                                <p class="text-3xl font-bold text-blue-600">${volunteer.hours || 0}</p>
                            </div>
                            <div class="sdipp-card p-6">
                                <p class="text-sm text-gray-600 mb-1">Points</p>
                                <p class="text-3xl font-bold text-green-600">${volunteer.points || 0}</p>
                            </div>
                            <div class="sdipp-card p-6">
                                <p class="text-sm text-gray-600 mb-1">Rank</p>
                                <p class="text-2xl font-bold">${volunteer.rank || 'Novice'}</p>
                            </div>
                            <div class="sdipp-card p-6">
                                <p class="text-sm text-gray-600 mb-1">Absences</p>
                                <p class="text-3xl font-bold text-red-600">${volunteer.absences || 0}</p>
                            </div>
                        </div>

                        <div class="grid md:grid-cols-2 gap-6 mb-8">
                            <div class="sdipp-card p-6">
                                <h3 class="font-bold mb-4">Account Status</h3>
                                ${volunteer.isProbation ? `
                                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-3">
                                        <p class="font-semibold text-orange-900">‚ö†Ô∏è On Probation</p>
                                        <p class="text-sm text-orange-700">Until: ${volunteer.probationUntil?.toDate().toLocaleDateString()}</p>
                                        <p class="text-sm text-orange-700">Reason: ${volunteer.probationReason}</p>
                                    </div>
                                ` : ''}
                                ${!volunteer.isTrainingCompleted ? `
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-3">
                                        <p class="font-semibold text-blue-900">üìö Training Required</p>
                                        <p class="text-sm text-blue-700">Must attend General Training event</p>
                                    </div>
                                ` : `
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-3">
                                        <p class="font-semibold text-green-900">‚úì Training Completed</p>
                                    </div>
                                `}
                                <p class="text-sm text-gray-600"><strong>Interests:</strong> ${(volunteer.interests || []).join(', ')}</p>
                                <p class="text-sm text-gray-600 mt-2"><strong>Populations:</strong> ${(volunteer.population || []).join(', ')}</p>
                            </div>

                            <div class="sdipp-card p-6">
                                <h3 class="font-bold mb-4">Attendance Summary</h3>
                                <div id="volunteer-attendance-summary">Loading...</div>
                            </div>
                        </div>

                        <div class="sdipp-card p-6">
                            <h3 class="font-bold mb-4">Event History</h3>
                            <div id="volunteer-event-history">Loading...</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEventForm(event = null) {
            const isEdit = event !== null;
            const eventDate = isEdit && event.date?.toDate ? event.date.toDate().toISOString().split('T')[0] : '';
            
            return `
                <form id="event-form" class="space-y-4" onsubmit="handleEventFormSubmit(event, ${isEdit})">
                    <input type="text" id="event-title" placeholder="Event Title *" value="${isEdit ? event.title : ''}" class="w-full px-4 py-2 border rounded-lg" required />
                    <input type="text" id="event-subtitle" placeholder="Subtitle (optional)" value="${isEdit ? event.subtitle || '' : ''}" class="w-full px-4 py-2 border rounded-lg" />
                    
                    <div class="grid grid-cols-3 gap-4">
                        <input type="date" id="event-date" value="${eventDate}" class="px-4 py-2 border rounded-lg" required />
                        <input type="time" id="event-start" value="${isEdit ? event.startTime : ''}" class="px-4 py-2 border rounded-lg" required />
                        <input type="time" id="event-end" value="${isEdit ? event.endTime : ''}" class="px-4 py-2 border rounded-lg" required />
                    </div>

                    <input type="text" id="event-location" placeholder="Location *" value="${isEdit ? event.location : ''}" class="w-full px-4 py-2 border rounded-lg" required />
                    <input type="url" id="event-location-link" placeholder="Google Maps Link *" value="${isEdit ? event.locationLink : ''}" class="w-full px-4 py-2 border rounded-lg" required />

                    <div>
                        <label class="font-semibold mb-2 block">Tags:</label>
                        <div id="tags-container" class="grid grid-cols-3 gap-2 mb-3">
                            ${allTags.map(tag => `
                                <label class="flex items-center gap-2 text-sm">
                                    <input type="checkbox" name="event-tags" value="${tag}" ${isEdit && event.tags?.includes(tag) ? 'checked' : ''} class="rounded" />
                                    ${tag}
                                </label>
                            `).join('')}
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="new-tag-input" placeholder="New tag name" class="flex-1 px-4 py-2 border rounded-lg" />
                            <button type="button" onclick="addNewTagToForm()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Add Tag</button>
                        </div>
                    </div>

                    <textarea id="event-description" placeholder="Description *" class="w-full px-4 py-2 border rounded-lg h-32" required>${isEdit ? event.description : ''}</textarea>

                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="text-sm font-medium mb-1 block">Capacity</label>
                            <input type="number" id="event-capacity" value="${isEdit ? event.maxCapacity : 20}" class="w-full px-4 py-2 border rounded-lg" required min="1" />
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-1 block">Hours Awarded</label>
                            <input type="number" id="event-hours" value="${isEdit ? event.hoursAwarded || 0 : 0}" class="w-full px-4 py-2 border rounded-lg" required min="0" step="0.5" />
                        </div>
                        <div>
                            <label class="text-sm font-medium mb-1 block">Points Awarded</label>
                            <input type="number" id="event-points" value="${isEdit ? event.pointsAwarded || 0 : 0}" class="w-full px-4 py-2 border rounded-lg" required min="0" />
                        </div>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="closeModal('${isEdit ? 'edit' : 'create'}-event-modal')" class="flex-1 px-6 py-3 border rounded-lg hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="flex-1 sdipp-btn sdipp-btn-primary">${isEdit ? 'Update' : 'Create'} Event</button>
                    </div>
                </form>
            `;
        }

        // ===================================
        // EVENT HANDLERS
        // ===================================
        
        function attachEventListeners() {
            window.showSignup = () => {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('signup-form').classList.remove('hidden');
            };

            window.showLogin = () => {
                document.getElementById('signup-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            };

            window.handleLogin = async () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorDiv = document.getElementById('login-error');

                if (!email || !password) {
                    errorDiv.textContent = 'Please fill in all fields';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                const result = await signIn(email, password);
                if (!result.success) {
                    errorDiv.textContent = result.error;
                    errorDiv.classList.remove('hidden');
                }
            };

            window.handleSignup = async () => {
                const firstName = document.getElementById('signup-firstname').value;
                const lastName = document.getElementById('signup-lastname').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const errorDiv = document.getElementById('signup-error');

                const interests = Array.from(document.querySelectorAll('input[name="interests"]:checked')).map(el => el.value);
                const population = Array.from(document.querySelectorAll('input[name="population"]:checked')).map(el => el.value);
                const emailNotifications = document.getElementById('email-consent').checked;

                if (!firstName || !lastName || !email || !password) {
                    errorDiv.textContent = 'Please fill in all required fields';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                if (password.length < 6) {
                    errorDiv.textContent = 'Password must be at least 6 characters';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                if (interests.length === 0 || population.length === 0) {
                    errorDiv.textContent = 'Please select at least one interest and population';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                const result = await signUp(email, password, {
                    firstName, lastName, interests, population, emailNotifications
                });

                if (!result.success) {
                    errorDiv.textContent = result.error;
                    errorDiv.classList.remove('hidden');
                }
            };

            window.handleLogout = logOut;

            window.handleRegister = async (eventId) => {
                const result = await registerForEvent(eventId, currentUser.uid);
                if (result.success) {
                    await loadData();
                    render();
                } else {
                    alert(result.error);
                }
            };

            window.handleUnregister = async (eventId) => {
                if (confirm('Cancel registration?')) {
                    const result = await unregisterFromEvent(eventId, currentUser.uid);
                    if (result.success) {
                        await loadData();
                        render();
                    }
                }
            };

            window.handleRedeemReward = async (rewardId) => {
                if (confirm('Redeem this reward?')) {
                    const result = await redeemReward(rewardId, currentUser.uid);
                    if (result.success) {
                        alert('Reward redeemed!');
                        await loadData();
                        render();
                    } else {
                        alert(result.error);
                    }
                }
            };

            window.setAdminTab = (tab) => {
                ['events', 'attendance', 'volunteers'].forEach(t => {
                    const btn = document.getElementById(`tab-${t}`);
                    if (btn) {
                        btn.classList.remove('text-red-600', 'border-b-2', 'border-red-600');
                        btn.classList.add('text-gray-600');
                    }
                });
                
                const activeBtn = document.getElementById(`tab-${tab}`);
                if (activeBtn) {
                    activeBtn.classList.remove('text-gray-600');
                    activeBtn.classList.add('text-red-600', 'border-b-2', 'border-red-600');
                }

                const content = document.getElementById('admin-content');
                if (tab === 'events') {
                    content.innerHTML = renderAdminEventsTab();
                } else if (tab === 'attendance') {
                    content.innerHTML = renderAdminAttendanceTab();
                    loadAllAttendance();
                } else if (tab === 'volunteers') {
                    content.innerHTML = renderAdminVolunteersTab();
                }
            };

            window.showCreateEventModal = () => {
                document.getElementById('event-form-container').innerHTML = renderEventForm();
                document.getElementById('create-event-modal').classList.add('show');
            };

            window.showEditEventModal = (eventId) => {
                const event = allEvents.find(e => e.id === eventId);
                if (event) {
                    window.editingEventId = eventId;
                    document.getElementById('edit-event-form-container').innerHTML = renderEventForm(event);
                    document.getElementById('edit-event-modal').classList.add('show');
                }
            };

            window.closeModal = (modalId) => {
                document.getElementById(modalId).classList.remove('show');
            };

            window.handleEventFormSubmit = async (e, isEdit) => {
                e.preventDefault();
                
                const tags = Array.from(document.querySelectorAll('input[name="event-tags"]:checked')).map(el => el.value);
                
                const eventData = {
                    title: document.getElementById('event-title').value,
                    subtitle: document.getElementById('event-subtitle').value,
                    date: document.getElementById('event-date').value,
                    startTime: document.getElementById('event-start').value,
                    endTime: document.getElementById('event-end').value,
                    location: document.getElementById('event-location').value,
                    locationLink: document.getElementById('event-location-link').value,
                    tags: tags,
                    description: document.getElementById('event-description').value,
                    maxCapacity: parseInt(document.getElementById('event-capacity').value),
                    hoursAwarded: parseFloat(document.getElementById('event-hours').value),
                    pointsAwarded: parseInt(document.getElementById('event-points').value)
                };

                let result;
                if (isEdit) {
                    result = await updateEvent(window.editingEventId, eventData);
                    closeModal('edit-event-modal');
                } else {
                    result = await createEvent(eventData);
                    closeModal('create-event-modal');
                }

                if (result.success) {
                    alert(`Event ${isEdit ? 'updated' : 'created'} successfully!`);
                    await loadData();
                    setAdminTab('events');
                } else {
                    alert('Error: ' + result.error);
                }
            };

            window.addNewTagToForm = async () => {
                const input = document.getElementById('new-tag-input');
                const tagName = input.value.trim();
                
                if (!tagName) {
                    alert('Please enter a tag name');
                    return;
                }

                const result = await addNewTag(tagName);
                if (result.success) {
                    input.value = '';
                    // Refresh tags container
                    const container = document.getElementById('tags-container');
                    container.innerHTML = allTags.map(tag => `
                        <label class="flex items-center gap-2 text-sm">
                            <input type="checkbox" name="event-tags" value="${tag}" ${tag === tagName ? 'checked' : ''} class="rounded" />
                            ${tag}
                        </label>
                    `).join('');
                } else {
                    alert('Error adding tag: ' + result.error);
                }
            };

            window.handleDeleteEvent = async (eventId) => {
                if (confirm('Delete this event permanently?')) {
                    const result = await deleteEvent(eventId);
                    if (result.success) {
                        await loadData();
                        setAdminTab('events');
                    }
                }
            };

            window.handleMarkAllAttended = async (eventId) => {
                if (confirm('Mark all registered volunteers as attended?')) {
                    const result = await markAllAttended(eventId);
                    if (result.success) {
                        alert('All volunteers marked as attended!');
                        await loadData();
                        setAdminTab('attendance');
                    } else {
                        alert('Error: ' + result.error);
                    }
                }
            };

            window.handleMarkSingleAttendance = async (eventId, userId, status) => {
                const result = await markAttendance(eventId, userId, status);
                if (result.success) {
                    await loadData();
                    loadAttendanceForEvent(eventId);
                }
            };

            window.showVolunteerDetail = async (userId) => {
                selectedVolunteerId = userId;
                currentView = 'volunteer-detail';
                render();
                
                // Load volunteer attendance data
                const attendance = await getVolunteerAttendance(userId);
                const volunteer = allVolunteers.find(v => v.id === userId);
                
                const summaryDiv = document.getElementById('volunteer-attendance-summary');
                if (summaryDiv) {
                    summaryDiv.innerHTML = `
                        <p class="mb-2"><strong>Events Completed:</strong> ${attendance.length}</p>
                        <p class="mb-2"><strong>Events Registered:</strong> ${(volunteer.registeredEvents || []).length}</p>
                        <p><strong>Absences:</strong> ${volunteer.absences || 0}</p>
                    `;
                }

                const historyDiv = document.getElementById('volunteer-event-history');
                if (historyDiv) {
                    if (attendance.length > 0) {
                        historyDiv.innerHTML = `
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-sm font-semibold">Event</th>
                                        <th class="px-4 py-2 text-left text-sm font-semibold">Date</th>
                                        <th class="px-4 py-2 text-left text-sm font-semibold">Hours</th>
                                        <th class="px-4 py-2 text-left text-sm font-semibold">Points</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    ${attendance.map(att => `
                                        <tr>
                                            <td class="px-4 py-2">${att.eventTitle}</td>
                                            <td class="px-4 py-2 text-sm">${formatDate(att.eventDate)}</td>
                                            <td class="px-4 py-2 font-semibold text-blue-600">${att.hoursEarned}</td>
                                            <td class="px-4 py-2 font-semibold text-green-600">${att.pointsEarned}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    } else {
                        historyDiv.innerHTML = '<p class="text-gray-500 text-center py-8">No completed events yet</p>';
                    }
                }
            };

            window.backToAdmin = () => {
                selectedVolunteerId = null;
                currentView = 'main';
                render();
            };

            window.filterVolunteers = () => {
                const searchTerm = document.getElementById('volunteer-search').value.toLowerCase();
                const rows = document.querySelectorAll('.volunteer-row');
                
                rows.forEach(row => {
                    const name = row.dataset.name.toLowerCase();
                    if (name.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            };

            window.sortVolunteers = (column) => {
                // Simple sort implementation
                alert('Sorting by ' + column);
            };

            async function loadAllAttendance() {
                for (const event of allEvents) {
                    if (event.registeredCount > 0) {
                        await loadAttendanceForEvent(event.id);
                    }
                }
            }

            async function loadAttendanceForEvent(eventId) {
                const attendanceList = await getEventAttendance(eventId);
                const container = document.getElementById(`attendance-${eventId}`);
                
                if (!container) return;

                if (attendanceList.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">No volunteers registered</p>';
                    return;
                }

                container.innerHTML = `
                    <div class="space-y-2">
                        ${attendanceList.map(att => {
                            const volunteer = allVolunteers.find(v => v.id === att.userId);
                            if (!volunteer) return '';
                            
                            return `
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">${att.status === 'attended' ? '‚úÖ' : att.status === 'absent' ? '‚ùå' : '‚è≥'}</span>
                                        <div>
                                            <p class="font-semibold text-sm">${volunteer.firstName} ${volunteer.lastName}</p>
                                            <p class="text-xs text-gray-600">${volunteer.email}</p>
                                        </div>
                                    </div>
                                    ${att.status === 'registered' ? `
                                        <div class="flex gap-2">
                                            <button onclick="handleMarkSingleAttendance('${eventId}', '${att.userId}', 'attended')" 
                                                class="px-3 py-1 bg-green-600 text-white rounded-lg text-xs hover:bg-green-700">
                                                Present
                                            </button>
                                            <button onclick="handleMarkSingleAttendance('${eventId}', '${att.userId}', 'absent')" 
                                                class="px-3 py-1 bg-red-600 text-white rounded-lg text-xs hover:bg-red-700">
                                                Absent
                                            </button>
                                        </div>
                                    ` : `
                                        <span class="text-xs font-semibold ${att.status === 'attended' ? 'text-green-600' : 'text-red-600'}">
                                            ${att.status === 'attended' ? 'Attended' : 'Absent'}
                                        </span>
                                    `}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            window.loadAttendanceForEvent = loadAttendanceForEvent;

            if (currentUserData?.role === 'admin' && currentView === 'main') {
                setTimeout(() => window.setAdminTab('events'), 100);
            }
        }

        // ===================================
        // UTILITY FUNCTIONS
        // ===================================
        
        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }

        async function loadData() {
            if (currentUser) {
                currentUserData = await getCurrentUserData(currentUser.uid);
                allEvents = await getAllEvents();
                allRewards = await getAllRewards();
                allTags = await getAllTags();
                if (currentUserData?.role === 'admin') {
                    allVolunteers = await getAllVolunteers();
                }
            }
        }

        // ===================================
        // INITIALIZE APP
        // ===================================
        
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                await loadData();
            }
            render();
        });

        render();
    </script>
</body>
</html>

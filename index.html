<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDIPP Volunteer Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --sdipp-primary: #dc2626; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .sdipp-gradient { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
        .sdipp-card { background: #fff; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: all 0.2s ease; }
        .sdipp-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); transform: translateY(-2px); }
        .sdipp-btn { border-radius: 12px; padding: 12px 24px; font-weight: 600; transition: all 0.2s ease; }
        .sdipp-btn-primary { background: var(--sdipp-primary); color: white; }
        .sdipp-btn-primary:hover { background: #b91c1c; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(220,38,38,0.3); }
        input[type="checkbox"]:checked, input[type="radio"]:checked { background-color: #dc2626; border-color: #dc2626; }
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .probation-banner { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 16px; border-radius: 12px; margin-bottom: 20px; }
        .training-required { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 16px; border-radius: 12px; margin-bottom: 20px; }
        .loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); z-index: 9999; }
        .loading.show { display: block; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="loading" class="loading"><p class="text-lg font-semibold">Loading...</p></div>
    <div id="app"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, arrayUnion, arrayRemove, query, where, orderBy, serverTimestamp, increment, Timestamp, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAUBj3-QxahYuhxjdkOfIAJzGtXiLp3_RA",
            authDomain: "sdipp-volunteer-portal.firebaseapp.com",
            projectId: "sdipp-volunteer-portal",
            storageBucket: "sdipp-volunteer-portal.firebasestorage.app",
            messagingSenderId: "1060878474479",
            appId: "1:1060878474479:web:9202a51329d172e4568f1a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, currentUserData = null, allEvents = [], allVolunteers = [], allRewards = [], allTags = [], currentView = 'main', selectedVolunteerId = null;

        function showLoading() { document.getElementById('loading').classList.add('show'); }
        function hideLoading() { document.getElementById('loading').classList.remove('show'); }

        async function signUp(email, password, userData) {
            try {
                showLoading();
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await updateProfile(user, { displayName: `${userData.firstName} ${userData.lastName}` });
                await setDoc(doc(db, 'users', user.uid), {
                    firstName: userData.firstName, lastName: userData.lastName, email, role: 'volunteer',
                    interests: userData.interests || [], population: userData.population || [],
                    emailNotifications: userData.emailNotifications || false,
                    hours: 0, points: 10, rank: 'Novice', registeredEvents: [], completedEvents: [],
                    isTrainingCompleted: false, absences: 0, isProbation: false, probationUntil: null, probationReason: '',
                    createdAt: serverTimestamp(), updatedAt: serverTimestamp()
                });
                await new Promise(resolve => setTimeout(resolve, 1000));
                hideLoading();
                return { success: true, user };
            } catch (error) {
                hideLoading();
                return { success: false, error: error.message };
            }
        }

        async function signIn(email, password) {
            try {
                showLoading();
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                await new Promise(resolve => setTimeout(resolve, 500));
                hideLoading();
                return { success: true, user: userCredential.user };
            } catch (error) {
                hideLoading();
                return { success: false, error: error.message };
            }
        }

        async function logOut() {
            await signOut(auth);
            currentUser = null;
            currentUserData = null;
            window.location.reload();
        }

        async function getCurrentUserData(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                if (!userDoc.exists()) return null;
                const data = { id: userDoc.id, ...userDoc.data() };
                if (data.isProbation && data.probationUntil && new Date() > data.probationUntil.toDate()) {
                    await updateDoc(doc(db, 'users', userId), { isProbation: false, probationUntil: null, probationReason: '', absences: 0 });
                    data.isProbation = false;
                }
                return data;
            } catch (error) { return null; }
        }

        async function getAllEvents() {
            try {
                const eventsSnapshot = await getDocs(query(collection(db, 'events'), orderBy('date', 'asc')));
                return eventsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) { return []; }
        }

        async function getAllVolunteers() {
            try {
                const volunteersSnapshot = await getDocs(collection(db, 'users'));
                return volunteersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) { return []; }
        }

        async function getAllRewards() {
            try {
                const rewardsSnapshot = await getDocs(query(collection(db, 'rewards'), where('available', '==', true)));
                return rewardsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) { return []; }
        }

        async function getAllTags() {
            try {
                const tagsSnapshot = await getDocs(collection(db, 'tags'));
                const tags = tagsSnapshot.docs.map(doc => doc.data().name);
                return [...new Set(tags)].sort();
            } catch (error) { return ['General Training', 'Pediatric', 'Health Education', 'CPR']; }
        }

        async function registerForEvent(eventId, userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                const userData = userDoc.data();
                if (userData.isProbation) throw new Error('You are on probation');
                const eventDoc = await getDoc(doc(db, 'events', eventId));
                const event = eventDoc.data();
                const isGeneralTraining = event.tags?.some(tag => tag.toLowerCase().includes('general training'));
                if (!isGeneralTraining && !userData.isTrainingCompleted) throw new Error('Complete General Training first');
                if (event.registeredCount >= event.maxCapacity) throw new Error('Event full');
                await updateDoc(doc(db, 'events', eventId), { registeredVolunteers: arrayUnion(userId), registeredCount: increment(1) });
                await updateDoc(doc(db, 'users', userId), { registeredEvents: arrayUnion(eventId), points: increment(5) });
                await setDoc(doc(db, 'attendance', `${eventId}_${userId}`), { eventId, userId, eventTitle: event.title, eventDate: event.date, hoursEarned: 0, pointsEarned: 5, status: 'registered', registeredAt: serverTimestamp() });
                return { success: true };
            } catch (error) { return { success: false, error: error.message }; }
        }

        async function createEvent(eventData) {
            try {
                const eventRef = doc(collection(db, 'events'));
                await setDoc(eventRef, { ...eventData, date: Timestamp.fromDate(new Date(eventData.date)), registeredCount: 0, registeredVolunteers: [], createdBy: currentUser.uid, createdAt: serverTimestamp() });
                return { success: true };
            } catch (error) { return { success: false, error: error.message }; }
        }

        async function markAllAttended(eventId) {
            try {
                const eventDoc = await getDoc(doc(db, 'events', eventId));
                const event = eventDoc.data();
                const batch = writeBatch(db);
                const isGeneralTraining = event.tags?.some(tag => tag.toLowerCase().includes('general training'));
                for (const userId of event.registeredVolunteers || []) {
                    batch.update(doc(db, 'attendance', `${eventId}_${userId}`), { status: 'attended', hoursEarned: event.hoursAwarded || 0, pointsEarned: event.pointsAwarded || 0, markedAt: serverTimestamp() });
                    const updateData = { hours: increment(event.hoursAwarded || 0), points: increment(event.pointsAwarded || 0), completedEvents: arrayUnion(eventId) };
                    if (isGeneralTraining) updateData.isTrainingCompleted = true;
                    batch.update(doc(db, 'users', userId), updateData);
                }
                await batch.commit();
                return { success: true };
            } catch (error) { return { success: false, error: error.message }; }
        }

        async function markAttendance(eventId, userId, status) {
            try {
                const eventDoc = await getDoc(doc(db, 'events', eventId));
                const event = eventDoc.data();
                const userDoc = await getDoc(doc(db, 'users', userId));
                const userData = userDoc.data();
                const isGeneralTraining = event.tags?.some(tag => tag.toLowerCase().includes('general training'));
                if (status === 'attended') {
                    await updateDoc(doc(db, 'attendance', `${eventId}_${userId}`), { status: 'attended', hoursEarned: event.hoursAwarded || 0, pointsEarned: event.pointsAwarded || 0 });
                    const updateData = { hours: increment(event.hoursAwarded || 0), points: increment(event.pointsAwarded || 0), completedEvents: arrayUnion(eventId) };
                    if (isGeneralTraining) updateData.isTrainingCompleted = true;
                    await updateDoc(doc(db, 'users', userId), updateData);
                } else {
                    await updateDoc(doc(db, 'attendance', `${eventId}_${userId}`), { status: 'absent' });
                    const newAbsences = (userData.absences || 0) + 1;
                    const updateData = { absences: newAbsences };
                    if (newAbsences >= 3) {
                        const probationEnd = new Date();
                        probationEnd.setMonth(probationEnd.getMonth() + 3);
                        updateData.isProbation = true;
                        updateData.probationUntil = Timestamp.fromDate(probationEnd);
                    }
                    await updateDoc(doc(db, 'users', userId), updateData);
                }
                return { success: true };
            } catch (error) { return { success: false, error: error.message }; }
        }

        async function getEventAttendance(eventId) {
            const snapshot = await getDocs(query(collection(db, 'attendance'), where('eventId', '==', eventId)));
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        function render() {
            const app = document.getElementById('app');
            if (!currentUser) app.innerHTML = renderAuthPage();
            else if (!currentUserData) app.innerHTML = '<div class="min-h-screen flex items-center justify-center"><p class="text-xl">Loading...</p></div>';
            else if (currentUserData.role === 'admin') app.innerHTML = currentView === 'volunteer-detail' ? renderVolunteerDetailPage() : renderAdminDashboard();
            else app.innerHTML = renderVolunteerDashboard();
            attachEventListeners();
        }

        function renderAuthPage() {
            return `<div class="min-h-screen sdipp-gradient flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                    <div class="text-center mb-8">
                        <img src="./sdipp-logo.webp" alt="SDIPP" class="mx-auto mb-4" style="max-width:200px" onerror="this.style.display='none'" />
                        <h1 class="text-3xl font-bold">SDIPP Volunteer Portal</h1>
                    </div>
                    <div id="login-form">
                        <h2 class="text-2xl font-bold mb-4">Sign In</h2>
                        <div id="login-error" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
                        <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-3 border rounded-xl mb-3" />
                        <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-3 border rounded-xl mb-4" />
                        <button onclick="handleLogin()" class="sdipp-btn sdipp-btn-primary w-full mb-3">Sign In</button>
                        <button onclick="showSignup()" class="w-full text-red-600 hover:underline">Create Account</button>
                    </div>
                    <div id="signup-form" class="hidden">
                        <h2 class="text-2xl font-bold mb-4">Join SDIPP</h2>
                        <div id="signup-error" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <input type="text" id="signup-firstname" placeholder="First Name *" class="px-4 py-3 border rounded-xl" />
                            <input type="text" id="signup-lastname" placeholder="Last Name *" class="px-4 py-3 border rounded-xl" />
                        </div>
                        <input type="email" id="signup-email" placeholder="Email *" class="w-full px-4 py-3 border rounded-xl mb-3" />
                        <input type="password" id="signup-password" placeholder="Password (min 6 chars) *" class="w-full px-4 py-3 border rounded-xl mb-4" />
                        <div class="mb-3">
                            <label class="font-semibold text-sm mb-2 block">Interests *</label>
                            <div class="grid grid-cols-2 gap-2">
                                ${['Pediatric', 'Health Education', 'Community Health', 'Sports Injury', 'Geriatric', 'Occupational Safety'].map(i => `<label class="flex items-center gap-2 text-sm"><input type="checkbox" name="interests" value="${i}" class="rounded" />${i}</label>`).join('')}
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="font-semibold text-sm mb-2 block">Population *</label>
                            <div class="grid grid-cols-2 gap-2">
                                ${['Children', 'Seniors', 'Veterans', 'Students'].map(p => `<label class="flex items-center gap-2 text-sm"><input type="checkbox" name="population" value="${p}" class="rounded" />${p}</label>`).join('')}
                            </div>
                        </div>
                        <div class="mb-4 p-4 bg-blue-50 rounded-xl">
                            <label class="flex items-start gap-3"><input type="checkbox" id="email-consent" class="mt-1 rounded" />
                            <div class="text-sm"><p class="font-semibold mb-1">üìß Email Notifications</p><p class="text-gray-700">Get event updates</p></div></label>
                        </div>
                        <button onclick="handleSignup()" class="sdipp-btn sdipp-btn-primary w-full mb-3">Create Account</button>
                        <button onclick="showLogin()" class="w-full text-red-600 hover:underline">Back to Sign In</button>
                    </div>
                </div>
            </div>`;
        }

        function renderVolunteerDashboard() {
            if (!currentUserData) return '';
            const registeredEvents = allEvents.filter(e => currentUserData.registeredEvents?.includes(e.id));
            const upcomingEvents = allEvents.filter(e => {
                const d = e.date?.toDate ? e.date.toDate() : new Date(e.date);
                return d > new Date() && !currentUserData.registeredEvents?.includes(e.id);
            });
            let banner = '';
            if (currentUserData.isProbation) banner = `<div class="probation-banner"><h3 class="font-bold mb-2">‚ö†Ô∏è On Probation</h3><p>Can't register until ${currentUserData.probationUntil?.toDate().toLocaleDateString()}</p></div>`;
            else if (!currentUserData.isTrainingCompleted) banner = `<div class="training-required"><h3 class="font-bold mb-2">üìö Training Required</h3><p>Complete <strong>General Training</strong> first</p></div>`;
            return `<div class="min-h-screen bg-gray-50">
                <header class="bg-white shadow-sm border-b">
                    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <img src="./sdipp-logo.webp" alt="SDIPP" class="h-12" onerror="this.style.display='none'" />
                            <h1 class="text-xl font-bold">Welcome, ${currentUserData.firstName}!</h1>
                        </div>
                        <button onclick="handleLogout()" class="px-4 py-2 hover:bg-gray-100 rounded-lg">Logout</button>
                    </div>
                </header>
                <div class="max-w-7xl mx-auto px-6 py-8">${banner}
                    <div class="grid md:grid-cols-4 gap-4 mb-8">
                        <div class="sdipp-card p-6"><p class="text-sm text-gray-600 mb-1">Hours</p><p class="text-3xl font-bold">${currentUserData.hours || 0}</p></div>
                        <div class="sdipp-card p-6"><p class="text-sm text-gray-600 mb-1">Rank</p><p class="text-3xl font-bold">${currentUserData.rank || 'Novice'}</p></div>
                        <div class="sdipp-card p-6"><p class="text-sm text-gray-600 mb-1">Points</p><p class="text-3xl font-bold">${currentUserData.points || 0}</p></div>
                        <div class="sdipp-card p-6"><p class="text-sm text-gray-600 mb-1">Events</p><p class="text-3xl font-bold">${registeredEvents.length}</p></div>
                    </div>
                    <div class="mb-8"><h2 class="text-2xl font-bold mb-4">Available Events</h2>
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${upcomingEvents.map(e => {
                                const d = e.date?.toDate ? e.date.toDate() : new Date(e.date);
                                const isFull = e.registeredCount >= e.maxCapacity;
                                const isTraining = e.tags?.some(t => t.toLowerCase().includes('general training'));
                                const canReg = !currentUserData.isProbation && (currentUserData.isTrainingCompleted || isTraining);
                                return `<div class="sdipp-card p-5">
                                    <h3 class="font-bold text-lg mb-2">${e.title}</h3>
                                    <div class="flex gap-2 mb-3">${(e.tags || []).map(t => `<span class="px-2 py-1 ${t.toLowerCase().includes('general training') ? 'bg-purple-100 text-purple-700' : 'bg-red-50 text-red-700'} rounded text-xs">${t}</span>`).join('')}</div>
                                    <p class="text-sm mb-3">${e.description || ''}</p>
                                    <p class="text-sm text-gray-600 mb-3">üìÖ ${d.toLocaleDateString()} ‚Ä¢ ${e.startTime}-${e.endTime}</p>
                                    <button onclick="handleRegister('${e.id}')" ${!canReg || isFull ? 'disabled' : ''} class="sdipp-btn w-full ${!canReg || isFull ? 'bg-gray-200 text-gray-400' : 'sdipp-btn-primary'}">
                                        ${isFull ? 'Full' : !canReg ? (currentUserData.isProbation ? 'Probation' : 'Training Req') : 'Register'}
                                    </button>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                    <div class="sdipp-card p-6 bg-gradient-to-br from-blue-50 to-indigo-50">
                        <h3 class="text-xl font-bold mb-3">Request Official Hours</h3>
                        <a href="https://docs.google.com/forms/d/e/1FAIpQLSciXetsMs3y6Xdf7iVHA4pFH1WtGFaU0V_LNqibdWjZL2YBJw/viewform" target="_blank" class="sdipp-btn sdipp-btn-primary inline-block w-full text-center">Request ‚Üí</a>
                    </div>
                </div>
            </div>`;
        }

        function renderAdminDashboard() {
            return `<div class="min-h-screen bg-gray-50">
                <header class="bg-white shadow-sm border-b">
                    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                        <h1 class="text-xl font-bold">Admin Dashboard</h1>
                        <button onclick="handleLogout()" class="px-4 py-2 hover:bg-gray-100 rounded-lg">Logout</button>
                    </div>
                </header>
                <div class="max-w-7xl mx-auto px-6 py-8">
                    <div class="flex gap-2 mb-6 border-b">
                        <button onclick="setAdminTab('events')" id="tab-events" class="px-6 py-3 font-semibold">Events</button>
                        <button onclick="setAdminTab('attendance')" id="tab-attendance" class="px-6 py-3 font-semibold">Attendance</button>
                        <button onclick="setAdminTab('volunteers')" id="tab-volunteers" class="px-6 py-3 font-semibold">Volunteers</button>
                    </div>
                    <div id="admin-content"></div>
                </div>
            </div>`;
        }

        function renderVolunteerDetailPage() {
            const v = allVolunteers.find(vol => vol.id === selectedVolunteerId);
            if (!v) { currentView = 'main'; render(); return ''; }
            return `<div class="min-h-screen bg-gray-50">
                <header class="bg-white shadow-sm border-b">
                    <div class="max-w-7xl mx-auto px-6 py-4">
                        <button onclick="backToAdmin()" class="text-blue-600 mb-2">‚Üê Back</button>
                        <h1 class="text-2xl font-bold">${v.firstName} ${v.lastName}</h1>
                    </div>
                </header>
                <div class="max-w-7xl mx-auto px-6 py-8">
                    <div class="grid md:grid-cols-4 gap-4 mb-8">
                        <div class="sdipp-card p-6"><p class="text-sm mb-1">Hours</p><p class="text-3xl font-bold text-blue-600">${v.hours || 0}</p></div>
                        <div class="sdipp-card p-6"><p class="text-sm mb-1">Points</p><p class="text-3xl font-bold text-green-600">${v.points || 0}</p></div>
                        <div class="sdipp-card p-6"><p class="text-sm mb-1">Rank</p><p class="text-2xl font-bold">${v.rank || 'Novice'}</p></div>
                        <div class="sdipp-card p-6"><p class="text-sm mb-1">Absences</p><p class="text-3xl font-bold text-red-600">${v.absences || 0}</p></div>
                    </div>
                </div>
            </div>`;
        }

        function attachEventListeners() {
            window.showSignup = () => { document.getElementById('login-form').classList.add('hidden'); document.getElementById('signup-form').classList.remove('hidden'); };
            window.showLogin = () => { document.getElementById('signup-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); };
            
            window.handleLogin = async () => {
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;
                const errorDiv = document.getElementById('login-error');
                if (!email || !password) { errorDiv.textContent = 'Fill all fields'; errorDiv.classList.remove('hidden'); return; }
                errorDiv.classList.add('hidden');
                const result = await signIn(email, password);
                if (!result.success) { errorDiv.textContent = result.error; errorDiv.classList.remove('hidden'); }
            };
            
            window.handleSignup = async () => {
                const firstName = document.getElementById('signup-firstname').value.trim();
                const lastName = document.getElementById('signup-lastname').value.trim();
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value;
                const errorDiv = document.getElementById('signup-error');
                const interests = Array.from(document.querySelectorAll('input[name="interests"]:checked')).map(el => el.value);
                const population = Array.from(document.querySelectorAll('input[name="population"]:checked')).map(el => el.value);
                const emailNotifications = document.getElementById('email-consent').checked;
                if (!firstName || !lastName || !email || !password) { errorDiv.textContent = 'Fill required fields'; errorDiv.classList.remove('hidden'); return; }
                if (password.length < 6) { errorDiv.textContent = 'Password min 6 chars'; errorDiv.classList.remove('hidden'); return; }
                if (!interests.length || !population.length) { errorDiv.textContent = 'Select interests & population'; errorDiv.classList.remove('hidden'); return; }
                errorDiv.classList.add('hidden');
                const result = await signUp(email, password, { firstName, lastName, interests, population, emailNotifications });
                if (!result.success) { errorDiv.textContent = result.error; errorDiv.classList.remove('hidden'); }
            };
            
            window.handleLogout = logOut;
            window.handleRegister = async (eventId) => { const r = await registerForEvent(eventId, currentUser.uid); if (r.success) { await loadData(); render(); } else alert(r.error); };
            window.setAdminTab = (tab) => {
                ['events', 'attendance', 'volunteers'].forEach(t => {
                    const btn = document.getElementById(`tab-${t}`);
                    if (btn) { btn.classList.remove('text-red-600', 'border-b-2', 'border-red-600'); btn.classList.add('text-gray-600'); }
                });
                const activeBtn = document.getElementById(`tab-${tab}`);
                if (activeBtn) { activeBtn.classList.remove('text-gray-600'); activeBtn.classList.add('text-red-600', 'border-b-2', 'border-red-600'); }
                const content = document.getElementById('admin-content');
                if (tab === 'events') content.innerHTML = '<p class="p-4">Events management coming soon</p>';
                else if (tab === 'attendance') { content.innerHTML = renderAdminAttendanceTab(); loadAllAttendance(); }
                else if (tab === 'volunteers') content.innerHTML = renderAdminVolunteersTab();
            };
            
            window.handleMarkAllAttended = async (eventId) => { if (confirm('Mark all as attended?')) { const r = await markAllAttended(eventId); if (r.success) { alert('Done!'); await loadData(); setAdminTab('attendance'); } } };
            window.handleMarkSingleAttendance = async (eventId, userId, status) => { await markAttendance(eventId, userId, status); await loadData(); loadAttendanceForEvent(eventId); };
            window.showVolunteerDetail = (userId) => { selectedVolunteerId = userId; currentView = 'volunteer-detail'; render(); };
            window.backToAdmin = () => { selectedVolunteerId = null; currentView = 'main'; render(); };
            
            async function loadAllAttendance() { for (const event of allEvents) if (event.registeredCount > 0) await loadAttendanceForEvent(event.id); }
            async function loadAttendanceForEvent(eventId) {
                const attendanceList = await getEventAttendance(eventId);
                const container = document.getElementById(`attendance-${eventId}`);
                if (!container) return;
                if (!attendanceList.length) { container.innerHTML = '<p class="text-gray-500 py-4">No volunteers</p>'; return; }
                container.innerHTML = `<div class="space-y-2">${attendanceList.map(att => {
                    const v = allVolunteers.find(vol => vol.id === att.userId);
                    if (!v) return '';
                    return `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex gap-3"><span class="text-2xl">${att.status === 'attended' ? '‚úÖ' : att.status === 'absent' ? '‚ùå' : '‚è≥'}</span>
                        <div><p class="font-semibold text-sm">${v.firstName} ${v.lastName}</p></div></div>
                        ${att.status === 'registered' ? `<div class="flex gap-2">
                            <button onclick="handleMarkSingleAttendance('${eventId}', '${att.userId}', 'attended')" class="px-3 py-1 bg-green-600 text-white rounded-lg text-xs">Present</button>
                            <button onclick="handleMarkSingleAttendance('${eventId}', '${att.userId}', 'absent')" class="px-3 py-1 bg-red-600 text-white rounded-lg text-xs">Absent</button>
                        </div>` : `<span class="text-xs font-semibold ${att.status === 'attended' ? 'text-green-600' : 'text-red-600'}">${att.status}</span>`}
                    </div>`;
                }).join('')}</div>`;
            }
            window.loadAttendanceForEvent = loadAttendanceForEvent;
            
            if (currentUserData?.role === 'admin' && currentView === 'main') setTimeout(() => window.setAdminTab('events'), 100);
        }

        function renderAdminAttendanceTab() {
            return `<div><h2 class="text-2xl font-bold mb-6">Mark Attendance</h2><div class="space-y-4">${allEvents.map(e => {
                const d = e.date?.toDate ? e.date.toDate() : new Date(e.date);
                return `<div class="sdipp-card p-6">
                    <div class="flex justify-between mb-4">
                        <div><h3 class="text-xl font-bold">${e.title}</h3><p class="text-sm text-gray-600">${d.toLocaleDateString()}</p></div>
                        ${e.registeredCount > 0 ? `<button onclick="handleMarkAllAttended('${e.id}')" class="sdipp-btn sdipp-btn-primary">‚úì Mark All</button>` : ''}
                    </div>
                    <div id="attendance-${e.id}"></div>
                </div>`;
            }).join('')}</div></div>`;
        }

        function renderAdminVolunteersTab() {
            const volunteers = allVolunteers.filter(v => v.role === 'volunteer').sort((a, b) => (b.hours || 0) - (a.hours || 0));
            return `<div><h2 class="text-2xl font-bold mb-6">Volunteers</h2><div class="sdipp-card overflow-hidden"><table class="w-full">
                <thead class="bg-gray-50 border-b"><tr>
                    <th class="px-6 py-3 text-left text-sm font-semibold">Name</th>
                    <th class="px-6 py-3 text-left text-sm font-semibold">Email</th>
                    <th class="px-6 py-3 text-left text-sm font-semibold">Hours</th>
                    <th class="px-6 py-3 text-left text-sm font-semibold">Status</th>
                    <th class="px-6 py-3 text-left text-sm font-semibold">Actions</th>
                </tr></thead>
                <tbody class="divide-y">${volunteers.map(v => `<tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-semibold">${v.firstName} ${v.lastName}</td>
                    <td class="px-6 py-4 text-sm">${v.email}</td>
                    <td class="px-6 py-4 font-semibold text-blue-600">${v.hours || 0}</td>
                    <td class="px-6 py-4">${v.isProbation ? '<span class="px-2 py-1 bg-orange-100 text-orange-700 text-xs rounded">Probation</span>' : !v.isTrainingCompleted ? '<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">Training Req</span>' : '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">Active</span>'}</td>
                    <td class="px-6 py-4"><button onclick="showVolunteerDetail('${v.id}')" class="text-blue-600 hover:text-blue-800">View</button></td>
                </tr>`).join('')}</tbody>
            </table></div></div>`;
        }

        async function loadData() {
            if (currentUser) {
                currentUserData = await getCurrentUserData(currentUser.uid);
                allEvents = await getAllEvents();
                allRewards = await getAllRewards();
                allTags = await getAllTags();
                if (currentUserData?.role === 'admin') allVolunteers = await getAllVolunteers();
            }
        }

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) { showLoading(); await loadData(); hideLoading(); }
            render();
        });

        render();
    </script>
</body>
</html>
